<template>
        <div class="page" data-name="stories">
            <div class="navbar">
              <div class="navbar-inner">
                <div class="title sliding">HackerNews7</div>
              </div>
            </div>
            <div class="toolbar tabbar">
              <div class="toolbar-inner">
                {{#each endpoints}}
                    <a href="#tab-{{@index}}" class="tab-link{{#js @first}} tab-link-active{{/if}}" @click="fetchStories({{@index}})">{{this.label}}</a>
                {{/each}}
              </div>
            </div>
            <div class="tabs">
            {{#each endpoints}}
                <div id="tab-{{@index}}" class="tab page-content{{#js_if '@root.currentTab === @index'}} tab-active{{/js_if}}" @infinite="loadMore">
                    <div class="list">
                        <ul>
                        {{#each @root.stories}}
                            <li>
                                <a href="/storie/{{id}}/" class="item-link">
                                <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title">
                                        {{title}} ({{domain}})
                                        <div class="item-footer">{{points}} {{pluralize points single="point" multiple="points"}} {{#if user}} by {{user}} {{/if}}{{time_ago}}</div>
                                    </div>
                                    {{#if comments_count}}<div class="item-after"><span class="badge">{{comments_count}}</span></div>{{/if}}
                                </div>
                                </div>
                                </a>
                            </li>
                        {{/each}}
                        </ul>
                    </div>
                    {{#if hasMoreItems}}
                    <div class="preloader infinite-scroll-preloader"></div>
                    {{/if}}
                </div>
                {{/each}}
            </div>
    </template>
    <script>
        return {
            data() {
                return {
                    allowInfinite: true,
                    hasMoreItems: true,
                    lastPage: 1,
                    currentTab: 0,
                    stories: null,
                    endpoints: [
                        {
                            label: 'top',
                            endpoint: 'news',
                        },
                        {
                            label: 'new',
                            endpoint: 'newest',
                        },
                        {
                            label: 'ask',
                            endpoint: 'ask',
                        },
                        {
                            label: 'jobs',
                            endpoint: 'jobs',
                        },
                        {
                            label: 'show',
                            endpoint: 'show',
                        },
                    ],
                }
            },
            methods: {
                fetchStories(index, page) {
                    var self = this;
                    var app = self.$app;
                    app.request.json('https://api.hnpwa.com/v0/' + this.endpoints[index].endpoint + '/' + page + '.json', (stories) => {
                        self.$setState({
                            stories: stories,
                            currentTab: index,
                        })
                    })
                },
                loadMore: function () {
                    var self = this;
                    var $ = self.$$;
                    if (!self.allowInfinite) return;
                    self.allowInfinite = false;

                    if (self.lastPage >= 10) {
                        self.$setState({
                            hasMoreItems: false,
                        });
                        return;
                    }
                    fetchStories(self.currentTab, self.lastPage + 1)
                    self.allowInfinite = true;
                    self.$setState({
                        lastItem: self.lastPage + 1,
                        stories: self.stories,
                    })
                }
            },
            on: {
                pageInit() {
                    var self = this;
                    self.fetchStories(0, 1);
                },
            },
        }
    </script>